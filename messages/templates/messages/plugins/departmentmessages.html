{% load message_tags %}
<div class="clear department-container tabs-container" id="tabbox_c">
    {#    <a class="arrow" href="#">#}
    {#        <img src="{{ STATIC_URL }}img/left.gif">#}
    {#    </a>#}
    {#    <a class="arrow_r" href="#">#}
    {#        <img src="{{ STATIC_URL }}img/right.gif">#}
    {#    </a>#}
    <ul class="tabs" id="tabs3">
        {% for dep in department_message_categories %}
            <li>
                <a href="#">{{ dep.short_name }}</a>
            </li>
        {% endfor %}
    </ul>
    <ul class="tab_conbox" id="tab_conbox3" style="background-color:#f5f5f5;">
        {% for dep in department_message_categories %}
            <li class="tab_con" style="display: list-item">
                <div class="term">
                    {% if dep.have_image %}
                        <dl class="one_third" style="margin-right: 9px !important; padding-left: 9px !important;">
                            <div class="portfolio_content_top_three">
                                <div class="port_img_three">
                                    <div class="preload preload_three">
                                        <a href="{% url get_department_image_big department_id=dep.id %}"
                                           class="attachment-fadeIn" rel="prettyPhoto[g1]" title="{{ dep.name }}"><img
                                                src="{{ STATIC_URL }}img/_global/img-zoom-3.png"
                                                style="position:absolute; display: none;" alt="CSS Template"/><img
                                                src="{% url get_department_image department_id=dep.id %}"
                                                alt="CSS Template" width="275" height="145"/></a>
                                    </div>
                                    <!-- end preload_four -->
                                </div>

                                <!-- end port_img_four -->
                            </div>
                        </dl>
                    {% endif %}
                    {% for cat in dep.message_categories %}
                        <dl style="margin-right: 9px !important; padding-left: 9px !important;"
                            class="
                                    {% if  dep.have_image %}{% cycle 'one_third' 'one_third' 'one_third' %}{% else %}{% cycle 'one_third' 'one_third' 'one_third' %}{% endif %}">
                            <dt>{{ cat.name }}
                                <a style="font-size: 12px;font-weight: normal;" class="message_more" target="_blank"
                                   href="{% url category_messages category_id=cat.id %}">
                                    更多</a>{% message_publish_url name=cat.name %}
                            </dt>
                            <div name="department_placeholder" id="{{ cat.id }}"
                                 default="{{ cat.default_message_count }}" depid="{{ dep.id }}"></div>

                        </dl>
                    {% endfor %}
                </div>
            </li>
        {% endfor %}
    </ul>
</div>
<script>
    $(function () {
        var department_load_cache = [];
        var tab = $("#tabs3")
        tab.find("li").bind("mouseover", function () {
            var activeindex = $("#tabs3").find("li").index(this);
            if (department_load_cache[activeindex] == undefined) {
                $("#tab_conbox3").children().eq(activeindex).find("div[name='department_placeholder']").each(function () {
                    var div_item = $(this);
                    $(this).text("");
                    $.ajax({
                        url: "{% url lazy_load %}",
                        data: {id: $(this).attr("id"), default: $(this).attr("default"), dep_id: $(this).attr("depid")},
                        dataType: 'json',
                        success: function (json) {
                            div_item.text("");
                            for (var i = 0; i < json.length; i++) {
                                var content = json[i];
                                var style = "";
                                var today = new Date();
                                var create_date = new Date(Date.parse(content.create_date_display.replace(/-/g, "/")));
                                if (today - create_date < 86400000) {
                                    style = "font-weight: bold";
                                }
                                var text = String.format('<dd> <a target="_blank" class="page-item" title="{0}"' +
                                        ' href="/message/message/{1}/">' +
                                        '<div style="{3}">{2}</div>' +
                                        '</a> </dd>', content.name, content.id, content.category_message_title_meta_display, style);
                                div_item.append(text);

                            }
                        },
                        beforeSend: function () {
                            div_item.append('<img style="margin-left:100px" src="{{ STATIC_URL }}img/index_loading.gif"  />');
                        }

                    });


                });
            }
            department_load_cache[activeindex] = true;

        });
        tab.find("li:first").mouseover();

    });
</script>