{% load message_tags %}
{% load i18n %}

<div class="one_half_last" id="tabbox2">
    <ul id="tabs2" class="tabs">
        {% for cat in message_categories %}
            <li class="{% if forloop.counter0 == 0 %}thistab {% endif %}">
                <a href="#">{{ cat.name }}</a>
            </li>
        {% endfor %}
    </ul>
    <ul id="tab_conbox2" class="tab_conbox" style="background-color:#f5f5f5;">
        {% for cat in message_categories %}
            <li class="tab_con" style="display: list-item">
                <div class="nr">

                    {% if cat.top_message %}
                        <div class="home-message-top">
                            <div class="home-message-image">
                                <a href="{{ cat.top_message.0|safe }}" class="attachment-fadeIn" rel="prettyPhoto[g1]"
                                   title="{{ cat.top_message.1.name|striptags|truncatehanzi:'16'|safe }}">
                                    <img src="{{ STATIC_URL }}img/_global/img-zoom-3.png"
                                         style="position:absolute; display: none;" alt="CSS Template"/>
                                    <img alt="CSS Template" width="275" height="145" class='img'
                                         src="{{ cat.top_message.0|safe }}"/>
                                </a>
                            </div>
                            <div class="home-message-content">
                                <h2 id="title">
                                    <a target="_blank"
                                       href="{% url messages_detail message_id=cat.top_message.1.id %}">{{ cat.top_message.1.name|striptags|truncatehanzi:'16'|safe }}</a>
                                </h2>
                                {% if  cat.top_message.1.content|striptags|truncatehanzi:'16'|safe %}
                                    <p class="top-message">{{ cat.top_message.1.content|striptags|truncatehanzi:'20'|safe }}</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <a class="message_more" target="_blank" href="{% url category_messages category_id=cat.id %}"><span>更多</span></a>
                    {% message_publish_url name=cat.name %}

                    <div name="right_placeholder" id="{{ cat.id }}"
                         default="{% if cat.top_message %} 3 {% else %} 8 {% endif %}"></div>
                </div>
            </li>
        {% endfor %}
    </ul>
</div>

<script>
    $(function () {
        var right_cache = [];
        var tab = $("#tabs2");
        tab.find("li").bind("mouseover", function () {
            var activeindex = tab.find("li").index(this);
            if (right_cache[activeindex] == undefined) {
                $("#tab_conbox2").children().eq(activeindex).find("div[name='right_placeholder']").each(function () {
                    var div_item = $(this);
                    $(this).text("");
                    $.ajax({
                        url: "{% url lazy_load %}",
                        data: {id: $(this).attr("id"), default: $(this).attr("default")},
                        dataType: 'json',
                        success: function (json) {
                            div_item.text("");
                            for (var i = 0; i < json.length; i++) {
                                var content = json[i];
                                var style = "";
                                var today = new Date();
                                var create_date = new Date(Date.parse(content.create_date_display.replace(/-/g, "/")));
                                if (today - create_date < 86400000) {
                                    style = "font-weight: bold";
                                }
                                var text = String.format('<p style="padding: 0;{3}"> <a target="_blank" class="page-item" title="{0}"' +
                                        ' href="/message/message/{1}/">{2}</a> </p>', content.name, content.id, content.category_message_title_meta_display, style);
                                div_item.append(text);

                            }
                        },
                        beforeSend: function () {
                            div_item.append('<img style="margin-left:100px" src="{{ STATIC_URL }}img/index_loading.gif"  />');
                        }

                    });


                });
            }
            right_cache[activeindex] = true;

        });
        tab.find("li:first").mouseover();

    });
</script>